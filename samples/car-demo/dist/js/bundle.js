"use strict";function e(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(e){this._divElement=e,this._divElement.innerHTML="",this._lines=[],this._maxLines=30}log(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.log(t),this._pushText(t)}error(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.error(t),this._pushText(`[ERR] - ${t}`)}_pushText(e){this._lines.push(e),this._lines.length>this._maxLines&&this._lines.splice(0,this._lines.length-this._maxLines),this._divElement.innerHTML=this._lines.map((e=>0===e.indexOf("[JS]")?`<span style="color: rgb(200,200,150);">${e}</span>`:0===e.indexOf("[C++]")?`<span style="color: rgb(150,150,200);">${e}</span>`:e)).join("<br>"),this._divElement.scrollTop=this._divElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1]}popLast(){this._lines.length>0&&this._lines.splice(this._lines.length-1,1)}}const i=/[?&]+([^=&]+)=([^&]*)/gi;class n{constructor(e,t,i){this._width=800,this._height=600,this._isInitialized=!1,this._isAborted=!1,this._canvas=e,this._onProgress=t,this._onError=i}initialize(t,i,n,s,o){return e(this,void 0,void 0,(function*(){if(this._width=t,this._height=i,!(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})())throw new Error("missing WebAssembly feature (unsupported)");if(o.log("[JS][check] WebAssembly feature => supported"),!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsupported)");o.log("[JS][check] WebGL2 feature => supported"),this._canvas.addEventListener("webglcontextcreationerror",(()=>{this._isAborted=!0,this._onError&&this._onError("Could not create a WebGL2 context.")}),!1),this._canvas.addEventListener("webglcontextlost",(()=>{this._isAborted=!0,this._onError&&this._onError("WebGL2 context lost. You will need to reload the page.")}),!1),this._canvas.addEventListener("contextmenu",(e=>{e.preventDefault()}),!1),this._webglCtx=(e=>{if(!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsuported)");const t=e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1});if(!t)throw new Error("WebGL2 context failed (initialisation)");return t})(this._canvas),o.log("[JS] WebGL2 context initialized"),yield this._setupWasmApplication(n,s,o)}))}_fetchWasmScript(t,i){return e(this,void 0,void 0,(function*(){i.log("[JS][wasm] fetching");const e=Date.now();var n;yield(n=`./${t}/index.js`,new Promise(((e,t)=>{const i=document.createElement("script");i.src=n,i.addEventListener("load",(()=>e())),i.addEventListener("error",(e=>t(e))),document.head.appendChild(i)})));const s=((Date.now()-e)/1e3).toFixed(3);i.log(`[JS][wasm] fetched ${s}sec`)}))}_loadWasmApplication(t,i){return e(this,void 0,void 0,(function*(){i.log("[JS] loading");const e=Date.now(),n=/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/;let s=0;const o={locateFile:e=>`${t}/${e}`,print:e=>{i.log(`[C++][out] ${e}`)},printErr:e=>{i.error(`[C++][err] ${e}`)},setStatus:e=>{if(!e)return;const t=n.exec(e);if(!t)return void i.log(`[JS][wasm][status] ${e}`);const o=parseFloat(t[1]),r=parseFloat(t[2]),a=Math.floor(o/r*100);s!==a&&(s=a,this._onProgress(a))},onRuntimeInitialized:()=>{i.log("[JS][wasm] runtime initialized")},canvas:this._canvas,preinitializedWebGLContext:this._webglCtx,noInitialRun:!0,noExitRuntime:!0};this._module=yield selfDriving3dCars(o);const r=((Date.now()-e)/1e3).toFixed(3);i.log(`[JS] loaded ${r}sec`)}))}_initializeWasmApplication(e){e.log("[JS][wasm] initializing");const t=Date.now(),i={startApplication:this._module.cwrap("startApplication",void 0,["number","number","number","number"]),updateApplication:this._module.cwrap("updateApplication",void 0,["number"]),renderApplication:this._module.cwrap("renderApplication",void 0,[])};this._wasmApplicationStartFunc=i.startApplication,this._wasmApplicationUpdateFunc=i.updateApplication,this._wasmApplicationRenderFunc=i.renderApplication,this._isInitialized=!0;const n=((Date.now()-t)/1e3).toFixed(3);e.log(`[JS][wasm] initialized ${n}sec`)}_setupWasmApplication(t,i,n){return e(this,void 0,void 0,(function*(){const e="wasm";yield this._fetchWasmScript(e,n),yield this._loadWasmApplication(e,n),this._initializeWasmApplication(n),n.log("[JS][wasm] running"),this._wasmApplicationStartFunc(this._width,this._height,t,i)}))}update(e){this._isInitialized&&!this._isAborted&&this._wasmApplicationUpdateFunc&&this._wasmApplicationUpdateFunc(e)}render(){this._isInitialized&&!this._isAborted&&this._wasmApplicationRenderFunc&&this._wasmApplicationRenderFunc()}abort(){this._isInitialized&&!this._isAborted&&(this._isAborted=!0,this._module&&(this._module.setStatus=e=>{e&&console.error(`[JS][wasm][aborted] ${e}`)}))}}const s=e=>{const t=document.querySelector(e);if(!t)throw new Error(`DOM elements not found, id=${e}`);return t};window.addEventListener("load",(()=>e(void 0,void 0,void 0,(function*(){let e=!0;const o=s("#loggerOutput"),r=new t(o);r.log("[JS] page loaded");const a=t=>{e=!1,r.error(`[JS] exception, message=${t.message}`)};window.addEventListener("error",a);const l=s("#errorText"),c=s("#renderArea"),d=s("#canvas"),h=e=>{"none"!==e.style.display&&(e.style.display="none")},p=e=>{"block"!==e.style.display&&(e.style.display="block")},u=e=>{l.innerHTML=e,h(d),p(l)};window.removeEventListener("error",a),window.addEventListener("error",(e=>{a(e),u(`fatal error, event=${e}`)}));const m=(e,t)=>e?parseInt(e,10):t,w=(()=>{const e={};let t=null;for(;t=i.exec(window.location.href);){const i=t[1],n=t[2];e[i]=n}return e})(),_={width:m(w.width,800),height:m(w.height,600),totalGenomes:m(w.totalGenomes,1e3),totalCores:m(w.totalCores,3)};var g,f;g=_.width,f=_.height,c.style.maxWidth=d.style.maxWidth=`${g}px`,c.style.maxHeight=d.style.maxHeight=`${f}px`,d.width=g,d.height=f;const b=new n(d,(e=>{const t=`Loading wasm [${e}%]`;r.size>0&&r.peekLast().indexOf("Loading wasm [")>=0&&r.popLast(),r.log(`[JS] ${t}`),u(t)}),u);try{yield b.initialize(_.width,_.height,_.totalGenomes,_.totalCores,r),h(l),p(d)}catch(e){r.error(`[JS] dependencies check failed: message="${e.message}"`),u(["this browser isn't compatible","error message:",`=> ${e.message}`].join("<br>"))}let v=Date.now();const A=()=>{e&&window.setTimeout(A,1e3/60);const t=Date.now(),i=t-v;v=t,b.update(i),b.render()};A()}))));
