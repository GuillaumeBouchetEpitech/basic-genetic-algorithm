"use strict";function t(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class e{constructor(t){this._divElement=t,this._divElement.innerHTML="",this._lines=[],this._maxLines=30}log(...t){if(0==t.length)return;const e=Array.prototype.slice.call(t).join(" ");console.log(e),this._pushText(e)}error(...t){if(0==t.length)return;const e=Array.prototype.slice.call(t).join(" ");console.error(e),this._pushText(`[ERR] - ${e}`)}_pushText(t){this._lines.push(t),this._lines.length>this._maxLines&&this._lines.splice(0,this._lines.length-this._maxLines),this._divElement.innerHTML=this._lines.map((t=>0===t.indexOf("[JS]")?`<span style="color: rgb(200,200,150);">${t}</span>`:0===t.indexOf("[C++]")?`<span style="color: rgb(150,150,200);">${t}</span>`:t)).join("<br>"),this._divElement.scrollTop=this._divElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1]}popLast(){this._lines.length>0&&this._lines.splice(this._lines.length-1,1)}}const i=/[?&]+([^=&]+)=([^&]*)/gi;class n{constructor(t,e,i){this._width=800,this._height=600,this._isInitialized=!1,this._isAborted=!1,this._canvas=t,this._onProgress=e,this._onError=i}initialize(e,i,n,s,o){return t(this,void 0,void 0,(function*(){if(this._width=e,this._height=i,!(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})())throw new Error("missing WebAssembly feature (unsupported)");if(o.log("[JS][check] WebAssembly feature => supported"),!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsupported)");o.log("[JS][check] WebGL2 feature => supported"),this._canvas.addEventListener("webglcontextcreationerror",(()=>{this._isAborted=!0,this._onError&&this._onError("Could not create a WebGL2 context.")}),!1),this._canvas.addEventListener("webglcontextlost",(()=>{this._isAborted=!0,this._onError&&this._onError("WebGL2 context lost. You will need to reload the page.")}),!1),this._canvas.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),this._webglCtx=(t=>{if(!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsuported)");const e=t.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1});if(!e)throw new Error("WebGL2 context failed (initialisation)");return e})(this._canvas),o.log("[JS] WebGL2 context initialized"),yield this._setupWasmApplication(n,s,o)}))}_fetchWasmScript(e,i){return t(this,void 0,void 0,(function*(){i.log("[JS][wasm] fetching");const t=Date.now();var n;yield(n=`./${e}/index.js`,new Promise(((t,e)=>{const i=document.createElement("script");i.src=n,i.addEventListener("load",(()=>t())),i.addEventListener("error",(t=>e(t))),document.head.appendChild(i)})));const s=((Date.now()-t)/1e3).toFixed(3);i.log(`[JS][wasm] fetched ${s}sec`)}))}_loadWasmApplication(e,i){return t(this,void 0,void 0,(function*(){i.log("[JS] loading");const t=Date.now(),n=/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/;let s=0;const o={locateFile:t=>`${e}/${t}`,print:t=>{i.log(`[C++][out] ${t}`)},printErr:t=>{i.error(`[C++][err] ${t}`)},setStatus:t=>{if(!t)return;const e=n.exec(t);if(!e)return void i.log(`[JS][wasm][status] ${t}`);const o=parseFloat(e[1]),r=parseFloat(e[2]),a=Math.floor(o/r*100);s!==a&&(s=a,this._onProgress(a))},onRuntimeInitialized:()=>{i.log("[JS][wasm] runtime initialized")},canvas:this._canvas,preinitializedWebGLContext:this._webglCtx,noInitialRun:!0,noExitRuntime:!0};this._module=yield selfDriving3dCars(o);const r=((Date.now()-t)/1e3).toFixed(3);i.log(`[JS] loaded ${r}sec`)}))}_initializeWasmApplication(t){t.log("[JS][wasm] initializing");const e=Date.now(),i={startApplication:this._module.cwrap("startApplication",void 0,["number","number","number","number"]),updateApplication:this._module.cwrap("updateApplication",void 0,["number"]),renderApplication:this._module.cwrap("renderApplication",void 0,[])};this._wasmApplicationStartFunc=i.startApplication,this._wasmApplicationUpdateFunc=i.updateApplication,this._wasmApplicationRenderFunc=i.renderApplication,this._isInitialized=!0;const n=((Date.now()-e)/1e3).toFixed(3);t.log(`[JS][wasm] initialized ${n}sec`)}_setupWasmApplication(e,i,n){return t(this,void 0,void 0,(function*(){const t="wasm";yield this._fetchWasmScript(t,n),yield this._loadWasmApplication(t,n),this._initializeWasmApplication(n),n.log("[JS][wasm] running"),this._wasmApplicationStartFunc(this._width,this._height,e,i)}))}update(t){this._isInitialized&&!this._isAborted&&this._wasmApplicationUpdateFunc&&this._wasmApplicationUpdateFunc(t)}render(){this._isInitialized&&!this._isAborted&&this._wasmApplicationRenderFunc&&this._wasmApplicationRenderFunc()}abort(){this._isInitialized&&!this._isAborted&&(this._isAborted=!0,this._module&&(this._module.setStatus=t=>{t&&console.error(`[JS][wasm][aborted] ${t}`)}))}}const s=t=>{const e=document.querySelector(t);if(!e)throw new Error(`DOM elements not found, id=${t}`);return e};window.addEventListener("load",(()=>t(void 0,void 0,void 0,(function*(){let t=!0;const o=s("#loggerOutput"),r=new e(o);r.log("[JS] page loaded");const a=e=>{t=!1,r.error(`[JS] exception, message=${e.message}`)};window.addEventListener("error",a);const l=s("#errorText"),c=s("#renderArea"),d=s("#canvas"),h={switchTo3cpuCores:s("#try_with_3_cpu_cores"),switchTo6cpuCores:s("#try_with_6_cpu_cores")},p=t=>{"none"!==t.style.display&&(t.style.display="none")},u=t=>{"block"!==t.style.display&&(t.style.display="block")},w=t=>{l.innerHTML=t,p(d),u(l)};window.removeEventListener("error",a),window.addEventListener("error",(t=>{a(t),w(`fatal error, event=${t}`)}));const m=(t,e)=>t?parseInt(t,10):e,_=(()=>{const t={};let e=null;for(;e=i.exec(window.location.href);){const i=e[1],n=e[2];t[i]=n}return t})(),g={width:m(_.width,800),height:m(_.height,600),totalGenomes:m(_.totalGenomes,1e3),totalCores:m(_.totalCores,3)};var f,b;f=g.width,b=g.height,c.style.maxWidth=d.style.maxWidth=`${f}px`,c.style.maxHeight=d.style.maxHeight=`${b}px`,d.width=f,d.height=b;const v=(t,e,i)=>{t.disabled=!1,t.classList.contains(e)||t.classList.add(e),t.classList.contains("grayButton")&&t.classList.remove("grayButton"),t.addEventListener("click",(()=>{window.location.href=window.location.pathname+`?totalCores=${i}`}))};3!=g.totalCores?(h.switchTo6cpuCores.disabled=!0,v(h.switchTo3cpuCores,"blueButton",3)):(h.switchTo3cpuCores.disabled=!0,v(h.switchTo6cpuCores,"redButton",6));const y=new n(d,(t=>{const e=`Loading wasm [${t}%]`;r.size>0&&r.peekLast().indexOf("Loading wasm [")>=0&&r.popLast(),r.log(`[JS] ${e}`),w(e)}),w);try{yield y.initialize(g.width,g.height,g.totalGenomes,g.totalCores,r),p(l),u(d)}catch(t){r.error(`[JS] dependencies check failed: message="${t.message}"`),w(["this browser isn't compatible","error message:",`=> ${t.message}`].join("<br>"))}let A=Date.now();const x=()=>{t&&window.setTimeout(x,1e3/60);const e=Date.now(),i=e-A;A=e,y.update(i),y.render()};x()}))));
